import olefile
import struct
import zlib
import io
import jsbeautifier as jsb

def get_dword(data, offset):
    return struct.unpack("<I", data[offset:offset + 4])[0]

def scan_hwp(filename):

    if olefile.isOleFile(filename):
        with olefile.OleFileIO(filename) as ole:
            for name in ole.listdir():
                name_str = '/'.join(name)
                print(name_str)
            
            if ole.exists('FileHeader'):
                fileheader = ole.openstream('FileHeader')
                t = fileheader.read()
                if t[0:17] == b'HWP Document File':
                    print('HWP File')
                    attr = get_dword(t, 0x24)
                    if attr & 0b000000000000000000000000000000001: # 0x1
                        print('Compressed File')
                        is_compressed = True
                    if attr & 0b000000000000000000000000000000010: # 0x2
                        print('Password Encrypted File')
                        return

                else:
                    print('Not HWP File')
                    return

            if ole.exists('Scripts/JScriptVersion'):
                jscript = ole.openstream('Scripts/JScriptVersion')
                if is_compressed:
                    version = zlib.decompress(jscript.read(), -15)
                else:
                    version = jscript.read()

                print("JScriptVersion:", version)

            if ole.exists('Scripts/DefaultJScript'):
                jscript = ole.openstream('Scripts/DefaultJScript')
                if is_compressed:
                    js_data = zlib.decompress(jscript.read(), -15)
                else:
                    js_data = jscript.read()
                    
                stringio = io.BytesIO(js_data)
                t = get_dword(stringio.read(4), 0x0)
                js1 = stringio.read(t*2).decode('utf-16')
                print("=================================================")
                print(jsb.beautify(js1))
                print("=================================================")
                t = get_dword(stringio.read(4), 0x0)
                js2 = stringio.read(t*2).decode('utf-16')
                print(jsb.beautify(js2))
                print("=================================================")
                
if __name__ == '__main__':
    filename = r'./062E1C4019462DB91B3171897554FC2B477C636576F3D94B98B0D4F594C9E786'
    scan_hwp(filename)